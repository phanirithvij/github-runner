# https://zhuanlan.zhihu.com/p/387389708?utm_id=0
# https://github.com/marketplace/actions/debugging-with-tmate
# https://github.com/marketplace/actions/debugging-with-ssh

# XXX 输入 exit 退出终端会断开连接，改动也会丢失

name: new_ssh_keep_connect

on:
  workflow_dispatch:
    inputs:
      SIMPLE_RUN:
        type: boolean
        description: "单纯起个 SSH（否则会安装依赖程序）"
        required: false
        default: false

env:
  FONT_DIR: mypy/assets/font
  ENV_INIT_SCRIPT: mypy/env_init.sh
  DEPENDENT_BINARY: "ffmpeg unoconv libreoffice poppler-utils"
  PYTHON_VERSION: 3.9

jobs:
  new_ssh_keep_connect:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4
        # XXX 外部仓库拉取时才需要设置凭证
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: M-Kepler/Python

      - name: 设置时区
        uses: szenius/set-timezone@v2.0
        with:
          timezoneLinux: "Asia/Shanghai"
          timezoneWindows: "China Standard Time"

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 安装依赖程序
        if: ${{ ! inputs.SIMPLE_RUN }}
        uses: ConorMacBride/install-package@v1.1.0
        with:
          apt: ${{ env.DEPENDENT_BINARY }}

      - name: 安装字体
        if: ${{ ! inputs.SIMPLE_RUN }}
        run: |
          bash mypy/build/install_font.sh ${{ env.FONT_DIR }}

      - name: 初始化运行环境
        run: |
          bash ${{ env.ENV_INIT_SCRIPT }}

      ##################################################
      # 从这里开始是对服务器的配置
      ##################################################
      # [阿里云盘命令行客户端](https://github.com/tickstep/aliyunpan)
      - name: 安装 aliyunpan
        if: ${{ ! inputs.SIMPLE_RUN }}
        run: |
          sudo curl -fsSL http://file.tickstep.com/apt/pgp | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/tickstep-packages-archive-keyring.gpg > /dev/null && echo "deb [signed-by=/etc/apt/trusted.gpg.d/tickstep-packages-archive-keyring.gpg arch=amd64,arm64] http://file.tickstep.com/apt aliyunpan main" | sudo tee /etc/apt/sources.list.d/tickstep-aliyunpan.list > /dev/null && sudo apt-get update && sudo apt-get install -y aliyunpan
          aliyunpan -v

      - name: 设置 Bash
        run: |
          cat << EOF >> ~/.bashrc
          set -o vi
          bind -m vi-insert '\c-l':clear-screen
          alias ..="cd .."
          alias ll='ls -l'
          alias la='ls -A'
          alias g='git'
          alias cls='clear'
          export PS1="\[\e[1;32m\]\u@\h\[\e[0m\]:\[\e[1;34m\]\w\[\e[0m\]\$ "
          EOF

          source ~/.bashrc

      # TODO 不可以 clone 其他仓库的代码
      # https://stackoverflow.com/questions/75578151/how-do-i-clone-a-repo-in-b-repo-github-actions-if-two-repo-is-in-same-organizati
      - name: 拉取 proxy_pool 代码
        uses: actions/checkout@v4
        env:
          MYPY_ACCESS_TOKEN: ${{ secrets.MYPY_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          token: ${{ env.MYPY_ACCESS_TOKEN }}
          repository: jhao104/proxy_pool
          path: proxy_pool

      # 会卡在这里等待链接，默认 15 分钟
      # 可以在连接后通过 `touch /tmp/keepalive` 保持连接
      # - name: 创建 SSH 会话
      #   uses: csexton/debugger-action@master
      - uses: fawazahmed0/action-debug@main
        with:
            credentials: "user:password"
